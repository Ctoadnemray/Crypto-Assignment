#!/usr/bin/env python3
"""
PA-2: Extract EC Curve Parameters from a Website Certificate
Author: <Your Name>

This script reads an exported X.509 certificate (.pem),
detects whether it uses Elliptic Curve Digital Signature Algorithm (ECDSA),
extracts the curve name, and prints:

 - Field characteristic p
 - Curve coefficients a and b
 - Elliptic curve equation: y^2 = x^3 + a*x + b (mod p)

Usage:
    python extract_ec_curve.py certificate.pem
"""

import sys
from cryptography import x509
from cryptography.hazmat.primitives.asymmetric import ec
from cryptography.hazmat.primitives import serialization
from ecdsa import curves


# Mapping from cryptography curve names â†’ python-ecdsa library curves
CURVE_MAP = {
    "prime256v1": curves.NIST256p,
    "secp256r1": curves.NIST256p,
    "P-256": curves.NIST256p,
    "secp384r1": curves.NIST384p,
    "P-384": curves.NIST384p,
    "secp521r1": curves.NIST521p,
    "P-521": curves.NIST521p,
    "secp256k1": curves.SECP256k1,
}


def print_curve_parameters(curve_obj):
    """Print p, a, b and the curve equation using python-ecdsa curve object."""

    p = curve_obj.curve.p()
    a = curve_obj.curve.a()
    b = curve_obj.curve.b()

    print("\n=== Elliptic Curve Parameters ===")
    print(f"Field characteristic p:\n  {hex(p)}")
    print(f"Coefficient a:\n  {hex(a)}")
    print(f"Coefficient b:\n  {hex(b)}")

    print("\nElliptic Curve Equation (short Weierstrass form):")
    print(f"  y^2 = x^3 + ({a})*x + ({b})  (mod {p})\n")


def main():
    if len(sys.argv) != 2:
        print("Usage: python extract_ec_curve.py certificate.pem")
        sys.exit(1)

    pem_file = sys.argv[1]

    # Load certificate
    with open(pem_file, "rb") as f:
        cert_data = f.read()

    try:
        cert = x509.load_pem_x509_certificate(cert_data)
    except Exception as e:
        print("Error: File is not a valid PEM certificate.")
        print(e)
        sys.exit(1)

    print("\n=== Certificate Loaded Successfully ===")
    print("Subject:", cert.subject.rfc4514_string())
    print("Issuer :", cert.issuer.rfc4514_string())

    public_key = cert.public_key()

    # Check whether key is EC
    if not isinstance(public_key, ec.EllipticCurvePublicKey):
        print("\nThis certificate does NOT use Elliptic Curve cryptography.")
        sys.exit(0)

    curve_name = public_key.curve.name
    print("\nPublic Key Algorithm: ECDSA")
    print("Elliptic Curve Name:", curve_name)

    # Map to known parameters
    curve_name_lower = curve_name.lower()
    ecdsa_curve = None

    for key in CURVE_MAP:
        if key.lower() == curve_name_lower:
            ecdsa_curve = CURVE_MAP[key]
            break

    if ecdsa_curve is None:
        print("\nCurve not found in local mapping. Add it manually.")
        sys.exit(0)

    print_curve_parameters(ecdsa_curve)


if __name__ == "__main__":
    main()
